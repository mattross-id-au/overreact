<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <script>
        
        customElements.define('ttt-square', class extends HTMLElement {      
            static observedAttributes = ["value"];

            connectedCallback() {
                this.shadow = this.attachShadow({mode: 'open'});
                this.shadow.innerHTML = `
                    <style>
                        :host { display: flex; }
                        :host([value=X]) button { color: oklch(0.6746 0.1519 48); }
                        :host([value=O]) button { color: oklch(0.6746 0.1519 228); }
                        button { 
                            flex-grow: 1; 
                            background-color: transparent;
                            font-size: 24px;
                            font-weight: bold;
                            border: 1px solid oklch(0.8 0 0);
                        }
                    </style>
                    <button class="square"></button>
                `
            }

            attributeChangedCallback(attribute) {
                if(attribute == 'value') {
                    const value = this.getAttribute(attribute);
                    const button = this.shadow.querySelector('button');
                    button.textContent = value;
                }
            }
        });


        customElements.define('ttt-board', class extends HTMLElement {

            connectedCallback() {
                this.nextPlayer = 'X';
                this.winner = null;

                this.addEventListener('click', (event)=> {
                    const squareElement = event.target.closest('[slot]');
                    if(squareElement) {
                        const isFree = squareElement.getAttribute("value") == "" || squareElement.getAttribute("value") == null;
                        const isGameOver = this.winner !== null;
                        if(isFree && !isGameOver) {
                            this.selectSquare(squareElement);
                            const winner = this.calculateWinner();
                            if(winner) {
                                this.shadow.getElementById("game").setAttribute("winner", winner);
                                this.shadow.querySelector("#winner span").textContent = winner;
                                this.winner = winner;
                            }
                        }
                    }
                })

                this.shadow = this.attachShadow({mode: 'open'});
                this.shadow.innerHTML = `
                    <style>
                        .board {
                            width: 150px;
                            height: 150px;
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            grid-template-rows: repeat(3, 1fr);
                            gap: 3px;
                        }
                        .board div { display: grid; }
                        #status {
                            margin: 1.5rem 0 3px 0; 
                            padding: 1rem;
                            box-sizing: border-box;
                            border: 1px solid oklch(0.8 0 0);
                            max-width: 150px;
                        }
                        #game[winner=''] #winner { display: none; }
                        #game:not([winner='']) #next-player { display: none; }
                    </style>
                    <div id="game" data-next-player="X" winner="">
                        <div id="status">
                            <div id="next-player">Next player: <span>${this.nextPlayer}</span></div>
                            <div id="winner">Winner: <span></span></div>
                        </div>
                        <div class="board">
                            <div><slot name="1-1"></slot></div>
                            <div><slot name="1-2"></slot></div>
                            <div><slot name="1-3"></slot></div>
                            <div><slot name="2-1"></slot></div>
                            <div><slot name="2-2"></slot></div>
                            <div><slot name="2-3"></slot></div>
                            <div><slot name="3-1"></slot></div>
                            <div><slot name="3-2"></slot></div>
                            <div><slot name="3-3"></slot></div>
                        </div>
                    </div>
                `;
            }

            selectSquare(squareElement) {
                squareElement.setAttribute("value", this.nextPlayer);
                this.nextPlayer = this.nextPlayer === 'X' ? 'O' : 'X';
                this.shadow.querySelector('#next-player span').textContent = this.nextPlayer;
            }

            calculateWinner() {
                const squares = new Map();
                for(const squareElement of this.querySelectorAll("[slot]")) {
                    squares.set(squareElement.getAttribute("slot"), squareElement.getAttribute("value"))
                }

                const lines = [
                    ['1-1','1-2','1-3'],
                    ['2-1','2-2','2-3'],
                    ['3-1','3-2','3-3'],
                    ['1-1','2-1','3-1'],
                    ['1-2','2-2','3-2'],
                    ['1-3','2-3','3-3'],
                    ['1-1','2-2','3-3'],
                    ['1-3','2-2','3-1']
                ];
                for(let i = 0; i < lines.length; i++) {
                    const [a,b,c] = lines[i];
                    if(squares.get(a) == squares.get(b) && squares.get(a) == squares.get(c)) {
                        return squares.get(a);
                    }
                }
                return null;
            }
        });
    </script>
</head>
<body>
    <ttt-board>
        <ttt-square slot="1-1"></ttt-square>
        <ttt-square slot="1-2"></ttt-square>
        <ttt-square slot="1-3"></ttt-square>
        <ttt-square slot="2-1"></ttt-square>
        <ttt-square slot="2-2"></ttt-square>
        <ttt-square slot="2-3"></ttt-square>
        <ttt-square slot="3-1"></ttt-square>
        <ttt-square slot="3-2"></ttt-square>
        <ttt-square slot="3-3"></ttt-square>
    </ttt-board>

    <ttt-board>
        <ttt-square slot="1-1"></ttt-square>
        <ttt-square slot="1-2"></ttt-square>
        <ttt-square slot="1-3"></ttt-square>
        <ttt-square slot="2-1"></ttt-square>
        <ttt-square slot="2-2"></ttt-square>
        <ttt-square slot="2-3"></ttt-square>
        <ttt-square slot="3-1"></ttt-square>
        <ttt-square slot="3-2"></ttt-square>
        <ttt-square slot="3-3"></ttt-square>
    </ttt-board>

    <ttt-board>
        <p slot="1-1">Top left</p>
        <ul slot="2-2">
            <li>Item 1</li>
            <li>Item 2</li>
        </ul>
        <p slot="3-3">Bottom right</p>
        <ttt-square slot="3-3"></ttt-square>
        <ttt-square slot="3-3"></ttt-square>
        <ttt-square slot="3-3"></ttt-square>
    </ttt-board>
</body>
</html>